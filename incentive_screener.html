<!DOCTYPE html>
<html>
<head>
    <title>Utility Incentive Eligibility Checker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* Loading Spinner Styles */
        #loader-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 1000;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Legend Styles */
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
    </style>
</head>

<body>

<div id="loader-container">
    <div class="spinner"></div>
    <p>Loading Rhode Island Circuit Data...</p>
</div>

<div id="map"></div>

<script>
    // Initialize Map
    const map = L.map('map').setView([41.6, -71.5], 10);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // Track loading status of both files
    let layersLoaded = 0;
    function checkLoad() {
        layersLoaded++;
        if (layersLoaded === 2) {
            document.getElementById('loader-container').style.display = 'none';
        }
    }

    // GitHub Raw URLs (Targeting 'main' branch)
    const loadScreenUrl = 'https://raw.githubusercontent.com/0jgreen0/hosting-capacity/main/ri_load_screen.json';
    const genScreenUrl = 'https://raw.githubusercontent.com/0jgreen0/hosting-capacity/main/ri_generation_screen.json';

    // --- 1. Load Screen Layer ---
    fetch(loadScreenUrl)
        .then(res => {
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
        })
        .then(topology => {
            const geojson = topojson.feature(topology, topology.objects.ri_load_screen);
            
            L.geoJSON(geojson, {
                style: (f) => ({
                    color: f.properties.HP_Electrification_Ready === 'YES' ? '#2ecc71' : '#e74c3c',
                    weight: 3,
                    opacity: 0.8
                }),
                onEachFeature: (f, l) => {
                    l.bindPopup(`
                        <strong>Feeder:</strong> ${f.properties.Feeder}<br>
                        <strong>Electrification Ready:</strong> ${f.properties.HP_Electrification_Ready}
                    `);
                }
            }).addTo(map);
            checkLoad();
        })
        .catch(err => {
            console.error('Error loading load screen:', err);
            checkLoad(); // Prevent loader from being stuck
        });

    // --- 2. Generation Screen Layer ---
    fetch(genScreenUrl)
        .then(res => {
            if (!res.ok) throw new Error('Network response was not ok');
            return res.json();
        })
        .then(topology => {
            const geojson = topojson.feature(topology, topology.objects.ri_generation_screen);
            
            L.geoJSON(geojson, {
                style: (f) => ({
                    color: f.properties.Gen_Utilization_Pct > 80 ? '#f39c12' : '#3498db',
                    weight: 2,
                    dashArray: '5, 5',
                    opacity: 0.7
                }),
                onEachFeature: (f, l) => {
                    l.bindPopup(`
                        <strong>Network ID:</strong> ${f.properties.Network_ID}<br>
                        <strong>Generation Utilization:</strong> ${f.properties.Gen_Utilization_Pct}%
                    `);
                }
            }).addTo(map);
            map.setView([data.lat, data.lon], 15);
        }
    </script>
</body>
</html>