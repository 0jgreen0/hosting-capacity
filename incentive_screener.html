<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Utility Incentive Eligibility Checker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/pmtiles@3.0.3/dist/pmtiles.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; color: #333; line-height: 1.5; background-color: #fcfcfc; }
        h2 { color: #015473; margin-top: 0; }

        .main-container { display: flex; flex-direction: column; gap: 20px; }
        .form-section { width: 100%; background: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; }

        #map { height: 500px; width: 100%; margin-top: 20px; border: 1px solid #B3B3B3; border-radius: 5px; position: relative; }

        .result { padding: 20px; margin: 15px 0; border-radius: 6px; border: 2px solid #B3B3B3; background: white; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #015473; margin-top: 15px; }
        .input-group input { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #B3B3B3; border-radius: 4px; box-sizing: border-box; }
        .input-group button { width: 100%; margin-top: 20px; padding: 14px; font-size: 16px; font-weight: bold; cursor: pointer; background-color: #068DBC; color: white; border: none; border-radius: 4px; transition: background 0.2s; }
        .input-group button:hover { background-color: #005a8d; }
        .input-group button:disabled { background-color: #ccc; cursor: not-allowed; }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header-row h4 { margin: 0; color: #015473; font-size: 1.1em; }

        .status-pill { display: inline-block; padding: 4px 12px; border-radius: 12px; font-weight: bold; font-size: 13px; color: white; min-width: 80px; text-align: center; }
        .pill-yes { background-color: #2ecc71; }
        .pill-no { background-color: #e74c3c; }

        .legend { position:absolute; bottom:10px; left:10px; padding: 12px; background: white; border: 2px solid #ccc; border-radius: 5px; font-size: 12px; box-shadow: 0 1px 5px rgba(0,0,0,0.2); z-index:2; }
        .legend i { width: 18px; height: 3px; float: left; margin-right: 8px; margin-top: 6px; }
        .legend-title { font-weight: bold; margin-bottom: 8px; }

        .conflict-warning { background: #fffbe6; border: 1px solid #ffe58f; padding: 12px; margin-top: 15px; border-radius: 4px; font-size: 13px; color: #856404; display: flex; align-items: flex-start; gap: 8px; }

        .disclaimer-box { margin-top: 30px; padding: 20px; border: 1px solid #B3B3B3; border-radius: 6px; background-color: #f9f9f9; }
        .disclaimer-box p { font-size: 13px; color: #444; line-height: 1.6; margin: 0; }
        .disclaimer-box a { color: #068DBC; text-decoration: none; font-weight: bold; }

        .explanation-text { font-size: 13px; color: #555; margin: 5px 0 15px 0; }

        #loading-status { font-style: italic; color: #068DBC; margin-top: 10px; font-size: 14px; }

        .layer-toggle { position: absolute; top: 10px; left: 10px; z-index: 3; background: white; border-radius: 4px; padding: 10px; box-shadow: 0 1px 5px rgba(0,0,0,0.2); }
        .layer-toggle label { display: block; margin: 5px 0; cursor: pointer; font-size: 13px; }
        .layer-toggle input { margin-right: 8px; }

        #spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 48px; height: 48px; border: 5px solid #ccc; border-top: 5px solid #068DBC; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .methodology-box { margin-top:30px; padding:20px; border:1px solid #ccc; border-radius:6px; background:#fff; }
        .methodology-box h3 { margin-top:0; color:#015473; }
        .methodology-box p, .methodology-box li { font-size:13px; color:#444; }
    </style>
</head>
<body>
<h2>Utility Incentive Eligibility Checker</h2>

<div class="main-container">
    <div class="form-section">
        <div class="input-group">
            <label for="address">Property Address (or Right‑Click Map)</label>
            <input id="address" type="text" placeholder="e.g., 82 Smith St, Providence, RI">

            <button id="check-btn" onclick="handleFormSubmit()" disabled>Loading data...</button>
            <div id="loading-status">Initializing vector tiles and inclusion zone...</div>
        </div>
        <div id="result"></div>
    </div>
</div>

<div id="map">
    <div class="layer-toggle">
        <label><input type="radio" name="layer" value="load" checked onchange="toggleLayer(this.value)"> Load Capacity</label>
        <label><input type="radio" name="layer" value="gen" onchange="toggleLayer(this.value)"> Hosting Capacity</label>
    </div>
</div>

<div class="disclaimer-box">
    <p><strong>Disclaimer:</strong> This tool reflects data from the Rhode Island Energy System Data Portal (<a href="https://www.rienergy.com/safety-community/system-data-portal" target="_blank">https://www.rienergy.com/safety-community/system-data-portal</a>). Results are for screening purposes only and do not guarantee incentive approval or interconnection capability.</p>
</div>

<div class="methodology-box">
<h3>Methodology</h3>
<ul>
<li>Addresses are geocoded using OpenStreetMap Nominatim and cached locally in your browser session.</li>
<li>Grid segments within 120 meters of the selected location are evaluated.</li>
<li>If multiple circuits are nearby, the most constrained circuit is used for eligibility determination.</li>
<li>Load capacity is used for heat pump and storage eligibility.</li>
<li>Generation hosting capacity is used for solar and storage eligibility.</li>
<li>Map layer visibility does not affect eligibility calculations.</li>
</ul>
</div>

<div id="spinner-overlay"><div class="spinner"></div></div>

<script>
const LOAD_PMTILES_URL = 'https://raw.githubusercontent.com/0jgreen0/hosting-capacity/main/ri_load_screen_1.pmtiles';
const GEN_PMTILES_URL = 'https://raw.githubusercontent.com/0jgreen0/hosting-capacity/main/ri_generation_screen.pmtiles';
const INCLUSION_GEOJSON_URL = 'https://raw.githubusercontent.com/0jgreen0/hosting-capacity/main/inclusion_map/inclusion_map.geojson';

const COLORS = { READY: '#0072B2', CONSTRAINED: '#D55E00' };
const NEARBY_THRESHOLD_METERS = 15.24; // 50 ft

let map, activeLayer = 'load', addressMarker, inclusionZoneData, legendDiv;
const geocodeCache = new Map();

function showSpinner(show){ document.getElementById('spinner-overlay').style.display = show ? 'flex' : 'none'; }

async function loadInclusionZone(){ const r = await fetch(INCLUSION_GEOJSON_URL); inclusionZoneData = await r.json(); }
loadInclusionZone();

function pointInPolygon(point, polygon){ let [x,y]=point, inside=false; for(let i=0,j=polygon.length-1;i<polygon.length;j=i++){ const xi=polygon[i][0], yi=polygon[i][1]; const xj=polygon[j][0], yj=polygon[j][1]; const intersect=((yi>y)!==(yj>y))&&(x<(xj-xi)*(y-yi)/(yj-yi)+xi); if(intersect) inside=!inside;} return inside; }

function isPointInInclusionZone(lon,lat){ if(!inclusionZoneData) return false; for(const f of inclusionZoneData.features){ if(f.geometry.type==='Polygon'){ if(pointInPolygon([lon,lat],f.geometry.coordinates[0])) return true; } if(f.geometry.type==='MultiPolygon'){ for(const p of f.geometry.coordinates){ if(pointInPolygon([lon,lat],p[0])) return true; } } } return false; }

let protocol=new pmtiles.Protocol(); maplibregl.addProtocol("pmtiles",protocol.tile);

map=new maplibregl.Map({
    container:'map',
    center:[-71.45,41.65],
    zoom:9,
    style:{
        version:8,
        sources:{
            carto:{type:'raster',tiles:['https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'],tileSize:256},
            load:{type:'vector',url:`pmtiles://${LOAD_PMTILES_URL}`},
            gen:{type:'vector',url:`pmtiles://${GEN_PMTILES_URL}`}
        },
        layers:[
            {id:'background',type:'raster',source:'carto'},
            // Visible layers for UI
            {id:'load-lines',type:'line',source:'load','source-layer':'load_capacity',paint:{'line-color':['case',['==',['get','constrained'],1],COLORS.CONSTRAINED,COLORS.READY],'line-width':2},layout:{visibility:'visible'}},
            {id:'gen-lines',type:'line',source:'gen','source-layer':'hosting_capacity',paint:{'line-color':['case',['==',['get','constrained'],1],COLORS.CONSTRAINED,COLORS.READY],'line-width':2},layout:{visibility:'none'}},
            // Invisible layers for data querying (ensures queryRenderedFeatures always works)
            {id:'load-logic',type:'line',source:'load','source-layer':'load_capacity',paint:{'line-opacity':0},layout:{visibility:'visible'}},
            {id:'gen-logic',type:'line',source:'gen','source-layer':'hosting_capacity',paint:{'line-opacity':0},layout:{visibility:'visible'}}
        ]
    }
});

map.addControl(new maplibregl.NavigationControl(),'bottom-right');

map.on('load',()=>{
    legendDiv=document.createElement('div'); legendDiv.className='legend'; map.getContainer().appendChild(legendDiv); updateLegend();
    const t=setInterval(()=>{ if(inclusionZoneData){ clearInterval(t); document.getElementById('loading-status').style.display='none'; const b=document.getElementById('check-btn'); b.disabled=false; b.textContent='Check Eligibility';}},100);
});

function updateLegend(){ if(!legendDiv) return; if(activeLayer==='load'){ legendDiv.innerHTML=`<div class='legend-title'>2025 Load Utilization</div><div><i style='background:${COLORS.CONSTRAINED}'></i> Constrained (>90%)</div><div><i style='background:${COLORS.READY}'></i> Capacity Ready (≤90%)</div>`;} else { legendDiv.innerHTML=`<div class='legend-title'>Hosting Capacity</div><div><i style='background:${COLORS.CONSTRAINED}'></i> Constrained (<0.5 MW)</div><div><i style='background:${COLORS.READY}'></i> Generation Ready (≥0.5 MW)</div>`;} }

function toggleLayer(layer){ activeLayer=layer; map.setLayoutProperty('load-lines','visibility',layer==='load'?'visible':'none'); map.setLayoutProperty('gen-lines','visibility',layer==='gen'?'visible':'none'); updateLegend(); }

address.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); handleFormSubmit(); }});

map.on('contextmenu',e=>{ const {lng,lat}=e.lngLat; address.value=`${lat.toFixed(5)}, ${lng.toFixed(5)}`; performCheck(lat,lng,'Coordinate Selected on Map'); });

async function handleFormSubmit(){ const addr=address.value.trim(); if(!addr) return; showSpinner(true); try{
    if(geocodeCache.has(addr)){ const c=geocodeCache.get(addr); performCheck(c.lat,c.lon,c.label); return; }
    const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}&limit=1`,{headers:{'User-Agent':'RI-Incentive-Screener/1.0'}});
    const d=await r.json(); if(!d.length) throw new Error('Address not found');
    const lat=parseFloat(d[0].lat), lon=parseFloat(d[0].lon), label=d[0].display_name;
    geocodeCache.set(addr,{lat,lon,label}); performCheck(lat,lon,label);
}catch(e){ alert(e.message); showSpinner(false);} }

function pickMostConstrained(features){ const constrained=features.filter(f=>f.properties.constrained===1); return constrained.length?constrained[0]:features[0]; }

async function performCheck(lat,lon,label){ 
    // 1. Placement and Camera Movement MUST happen first for PMTiles to load detail
    if(addressMarker) addressMarker.remove(); 
    addressMarker=new maplibregl.Marker().setLngLat([lon,lat]).addTo(map); 
    map.flyTo({center:[lon,lat],zoom:16});

    // 2. Wait for map to be idle (tiles at zoom 16 loaded)
    map.once('idle', () => {
        const inZone=isPointInInclusionZone(lon,lat);
        if(!inZone){ 
            document.getElementById('result').innerHTML=`<div class='result'><h3>Outside Service Territory</h3><p>This location is outside Rhode Island Energy's electric service territory and is not eligible for these incentives.</p></div>`; 
            showSpinner(false); 
            return; 
        }

        const pt=turf.point([lon,lat]);
        
        // Query against the invisible 'logic' layers which are always visibility:visible
        const loadFeatures = map.queryRenderedFeatures({ layers: ['load-logic'] })
            .filter(f => turf.pointToLineDistance(pt, f, { units: 'meters' }) <= NEARBY_THRESHOLD_METERS);
            
        const genFeatures = map.queryRenderedFeatures({ layers: ['gen-logic'] })
            .filter(f => turf.pointToLineDistance(pt, f, { units: 'meters' }) <= NEARBY_THRESHOLD_METERS);

        if(!loadFeatures.length){ 
            document.getElementById('result').innerHTML=`<div class='result'><h3>No Data</h3><p>This location is not near mapped grid infrastructure. Try checking a nearby intersection or right-clicking a line on the map.</p></div>`; 
            showSpinner(false); 
            return; 
        }

        const primaryLoad=pickMostConstrained(loadFeatures).properties;
        const primaryGen=genFeatures.length?pickMostConstrained(genFeatures).properties:{hosting_capacity_mw:0,constrained:1,Section_ID:'N/A'};

        const loadConflict=loadFeatures.some(f=>f.properties.constrained!==primaryLoad.constrained);
        const genConflict=genFeatures.some(f=>f.properties.constrained!==primaryGen.constrained);

        displayResults({label,lat,lon,load:primaryLoad,gen:primaryGen,hasConflict:loadConflict||genConflict}); 
        showSpinner(false);
    });
}

function displayResults(data){
    const isHPEligible=data.load.constrained===0;
    const isSolarEligible=data.gen.constrained===0;
    const isStorageEligible=data.load.constrained===1 && data.gen.constrained===1;

    const hpText=isHPEligible?'Great news! You are eligible for an enhanced incentive for heat pumps!':'Unfortunately, your local grid is near its rated capacity.';
    const solarText=isSolarEligible?'Great news! You are eligible for an enhanced incentive for distributed solar photovoltaics!':'Unfortunately, your local grid has high utilization from existing generation.';
    const storageText=isStorageEligible?'Great news! You are eligible for an enhanced incentive for battery energy storage.':'Your current local grid conditions do not meet the criteria for an enhanced storage incentive.';

    result.innerHTML=`<div class='result'><h3>Screening Results</h3><p style='font-size:0.9em;color:#666'><strong>Location:</strong> ${data.label}</p>
    <div class='header-row'><h4>Heat Pump Enhanced Incentive</h4><span class='status-pill ${isHPEligible?'pill-yes':'pill-no'}'>${isHPEligible?'ELIGIBLE':'NOT ELIGIBLE'}</span></div><div class='explanation-text'>${hpText}</div>
    <div class='header-row'><h4>Solar PV Enhanced Incentive</h4><span class='status-pill ${isSolarEligible?'pill-yes':'pill-no'}'>${isSolarEligible?'ELIGIBLE':'NOT ELIGIBLE'}</span></div><div class='explanation-text'>${solarText}</div>
    <div class='header-row'><h4>Battery Storage Enhanced Incentive</h4><span class='status-pill ${isStorageEligible?'pill-yes':'pill-no'}'>${isStorageEligible?'ELIGIBLE':'NOT ELIGIBLE'}</span></div><div class='explanation-text'>${storageText}</div>

    ${data.hasConflict?`<div class='conflict-warning'><span>⚠️</span><div><strong>Multi-Feeder Area:</strong> This property is near multiple circuits with different constraint profiles. Eligibility is displayed for the most constrained feeder found nearby.</div></div>`:''}

    <div style='font-size:11px;margin-top:20px;border-top:1px solid #ddd;padding-top:10px;color:#888'>Primary Feeder: ${data.load.Feeder || 'Unknown'} | Gen Section: ${data.gen.Section_ID} | 2025 Load: ${data.load.load_pct_25}% | Hosting Capacity: ${data.gen.hosting_capacity_mw} MW</div></div>`;
}

// ---- DEBUG PANEL ----
const debugPanel = document.createElement('div');
debugPanel.style.position = 'fixed';
debugPanel.style.right = '10px';
debugPanel.style.bottom = '10px';
debugPanel.style.width = '340px';
debugPanel.style.maxHeight = '220px';
debugPanel.style.overflowY = 'auto';
debugPanel.style.background = 'rgba(0,0,0,0.8)';
debugPanel.style.color = '#0f0';
debugPanel.style.fontSize = '11px';
debugPanel.style.fontFamily = 'monospace';
debugPanel.style.padding = '8px';
debugPanel.style.zIndex = '9999';
debugPanel.innerHTML = '<b>DEBUG</b><br>';
document.body.appendChild(debugPanel);

function debugLog(msg){
    const t = new Date().toLocaleTimeString();
    debugPanel.innerHTML += `[${t}] ${msg}<br>`;
    debugPanel.scrollTop = debugPanel.scrollHeight;
}

map.on('load', () => {
    debugLog('Map loaded');
});

map.on('idle', () => {
    try {
        const loadLoaded = map.isSourceLoaded('load');
        const genLoaded = map.isSourceLoaded('gen');
        const z = map.getZoom().toFixed(2);
        debugLog(`Zoom: ${z} | Sources: load=${loadLoaded}, gen=${genLoaded}`);

        if (loadLoaded) {
            const lf = map.queryRenderedFeatures({ layers: ['load-logic'] });
            debugLog('Load lines in current view: ' + lf.length);
        }
    } catch (e) {
        debugLog('Error querying sources: ' + e.message);
    }
});
</script>
</body>
</html>