<!DOCTYPE html>
<html>
<head>
    <title>Utility Incentive Eligibility Checker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; color: #333; line-height: 1.5; }
        h2 { color: #015473; margin-top: 0; }
        .main-container { display: flex; flex-direction: column; gap: 20px; }
        #map { height: 500px; width: 100%; margin-top: 20px; border: 1px solid #B3B3B3; border-radius: 5px; z-index: 1; position: relative; }
        .result { padding: 20px; margin: 15px 0; border-radius: 6px; border-width: 2px; border-style: solid; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .eligible { background: #eef6fb; border-color: #005a8d; }
        .not-eligible { background: #fff5eb; border-color: #d95f02; }
        .conflict-warning { background: #fffbe6; border: 1px solid #ffe58f; padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 13px; color: #856404; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #015473; margin-top: 15px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #B3B3B3; border-radius: 4px; box-sizing: border-box; }
        .input-group button { width: 100%; margin-top: 20px; padding: 12px; font-size: 16px; font-weight: bold; cursor: pointer; background-color: #068DBC; color: white; border: none; border-radius: 4px; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .status-pill { display: inline-block; padding: 4px 12px; border-radius: 12px; font-weight: bold; font-size: 13px; color: white; }
        .pill-yes { background-color: #2ecc71; }
        .pill-no { background-color: #e74c3c; }
        .legend { padding: 10px; background: white; border: 2px solid #ccc; border-radius: 5px; font-size: 12px; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.8; border-radius: 2px; }
        .map-btn { position: absolute; top: 80px; left: 10px; z-index: 1000; background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; padding: 5px 10px; cursor: pointer; font-weight: bold; }
        .map-btn:hover { background: #f4f4f4; }
    </style>
</head>

<body>
    <h2>Utility Incentive Eligibility Checker</h2>

    <div class="main-container">
        <div class="form-section">
            <div class="input-group">
                <label for="utility-select">1. Utility Provider</label>
                <select id="utility-select">
                    <option value="ri-energy">Rhode Island Energy</option>
                    <option value="crewd">Other Providers (Not Eligible)</option>
                </select>
                
                <label for="address">2. Property Address (or Right-Click Map)</label>
                <input id="address" type="text" placeholder="e.g., 123 Main St, Providence, RI">
                
                <button id="check-btn" onclick="handleFormSubmit()" disabled>Loading data...</button>
                <div id="loading-status" style="font-size: 14px; color: #068DBC; margin-top: 10px;">Initializing grid data...</div>
            </div>
            <div id="result"></div>
        </div>
    </div>
    
    <div id="map">
        <button class="map-btn" onclick="checkAtCenter()">üìç Pin Map Center</button>
    </div>

    <script>
        const LOAD_URL = 'https://raw.githubusercontent.com/0jgreen0/hosting-capacity/main/ri_load_screen.json';
        const GEN_URL = 'https://raw.githubusercontent.com/0jgreen0/hosting-capacity/main/ri_generation_screen.json';
        const FEET_200_KM = 0.06096;

        let map, loadLayer, genLayer, addressMarker, legend;
        let loadGeoJSON, genGeoJSON;
        let activeLayerName = "Load";

        // Initialize Map
        map = L.map('map').setView([41.65, -71.45], 10);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '¬© CARTO' }).addTo(map);

        // Load Data
        async function init() {
            try {
                const [lRes, gRes] = await Promise.all([fetch(LOAD_URL), fetch(GEN_URL)]);
                loadGeoJSON = await lRes.json();
                genGeoJSON = await gRes.json();

                loadLayer = L.geoJSON(loadGeoJSON, {
                    style: (f) => ({ color: f.properties.load_pct_25 > 90 ? '#e74c3c' : '#2ecc71', weight: 4, opacity: 0.8 })
                }).addTo(map);

                genLayer = L.geoJSON(genGeoJSON, {
                    style: (f) => ({ color: f.properties.hosting_capacity_mw < 0.5 ? '#e74c3c' : '#f39c12', weight: 4, opacity: 0.8 })
                });

                L.control.layers({ "Load Status": loadLayer, "Generation Capacity": genLayer }, null, {collapsed: false}).addTo(map);
                
                map.on('baselayerchange', (e) => {
                    activeLayerName = e.name.includes("Load") ? "Load" : "Gen";
                    updateLegend();
                });

                addLegend();
                document.getElementById('loading-status').style.display = 'none';
                document.getElementById('check-btn').disabled = false;
                document.getElementById('check-btn').textContent = 'Check Eligibility';
            } catch (e) {
                document.getElementById('loading-status').textContent = "Error loading data.";
            }
        }

        function addLegend() {
            legend = L.control({position: 'bottomright'});
            legend.onAdd = () => {
                const div = L.DomUtil.create('div', 'legend');
                div.id = "dynamic-legend";
                return div;
            };
            legend.addTo(map);
            updateLegend();
        }

        function updateLegend() {
            const div = document.getElementById('dynamic-legend');
            if (activeLayerName === "Load") {
                div.innerHTML = `<strong>2025 Load Status</strong><br>
                    <i style="background: #e74c3c"></i> Constrained (>90%)<br>
                    <i style="background: #2ecc71"></i> Capacity Available (<90%)`;
            } else {
                div.innerHTML = `<strong>Hosting Capacity</strong><br>
                    <i style="background: #e74c3c"></i> Constrained (<0.5 MW)<br>
                    <i style="background: #f39c12"></i> Ready (>0.5 MW)`;
            }
        }

        // Interaction Handlers
        map.on('contextmenu', (e) => {
            document.getElementById('address').value = `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
            performCheck(e.latlng.lat, e.latlng.lng, "Selected Map Location");
        });

        function checkAtCenter() {
            const center = map.getCenter();
            performCheck(center.lat, center.lng, "Map Center Location");
        }

        async function handleFormSubmit() {
            const addr = document.getElementById('address').value;
            if (!addr) return;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}&limit=1`);
                const data = await res.json();
                if (data.length === 0) throw new Error("Address not found.");
                performCheck(parseFloat(data[0].lat), parseFloat(data[0].lon), data[0].display_name);
            } catch (e) { alert(e.message); }
        }

        function performCheck(lat, lon, label) {
            const userPt = turf.point([lon, lat]);
            
            const getNearby = (geojson, type) => {
                let results = [];
                geojson.features.forEach(f => {
                    const dist = turf.pointToLineDistance(userPt, f, {units: 'kilometers'});
                    if (dist <= FEET_200_KM) {
                        const isConstrained = type === 'load' ? f.properties.load_pct_25 > 90 : f.properties.hosting_capacity_mw < 0.5;
                        results.push({ props: f.properties, isConstrained, dist });
                    }
                });
                return results.sort((a, b) => b.isConstrained - a.isConstrained); // Most constrained first
            };

            const nearbyLoad = getNearby(loadGeoJSON, 'load');
            const nearbyGen = getNearby(genGeoJSON, 'gen');

            if (nearbyLoad.length === 0) {
                document.getElementById('result').innerHTML = "No utility infrastructure found within 200ft.";
                return;
            }

            const bestLoad = nearbyLoad[0];
            const bestGen = nearbyGen[0] || { props: { hosting_capacity_mw: 0 }, isConstrained: true };
            
            // Conflict Flags
            const loadConflict = nearbyLoad.some(f => f.isConstrained !== bestLoad.isConstrained);
            const genConflict = nearbyGen.some(f => f.isConstrained !== bestGen.isConstrained);

            displayResults({
                label, lat, lon,
                load: bestLoad,
                gen: bestGen,
                hasConflict: loadConflict || genConflict
            });
        }

        function displayResults(data) {
            const resDiv = document.getElementById('result');
            const hpEligible = !data.load.isConstrained;
            const solarEligible = !data.gen.isConstrained;
            // Storage: Only if both are constrained (High Value Area)
            const storageEligible = data.load.isConstrained && data.gen.isConstrained;

            resDiv.innerHTML = `
                <div class="result ${hpEligible ? 'eligible' : 'not-eligible'}">
                    <h3>Eligibility: ${data.label}</h3>
                    
                    <div class="header-row">
                        <span>Heat Pump Incentive:</span>
                        <span class="status-pill ${hpEligible ? 'pill-yes' : 'pill-no'}">${hpEligible ? 'READY' : 'CONSTRAINED'}</span>
                    </div>

                    <div class="header-row">
                        <span>Solar PV Hosting:</span>
                        <span class="status-pill ${solarEligible ? 'pill-yes' : 'pill-no'}">${solarEligible ? 'READY' : 'CONSTRAINED'}</span>
                    </div>

                    <div class="header-row">
                        <span>Battery Storage Bonus:</span>
                        <span class="status-pill ${storageEligible ? 'pill-yes' : 'pill-no'}">${storageEligible ? 'ELIGIBLE' : 'NOT ELIGIBLE'}</span>
                    </div>

                    ${data.hasConflict ? `<div class="conflict-warning">‚ö†Ô∏è <strong>Multi-Feeder Area:</strong> Multiple circuits were found within 200ft with differing constraints. Eligibility shown is based on the most constrained circuit to ensure safety.</div>` : ''}

                    <div style="font-size:11px; margin-top:15px; border-top:1px solid #ddd; padding-top:10px;">
                        Feeder ID: ${data.load.props.Feeder} | 2025 Load: ${data.load.props.load_pct_25}% | Gen Capacity: ${data.gen.props.hosting_capacity_mw} MW
                    </div>
                </div>
            `;

            if (addressMarker) map.removeLayer(addressMarker);
            addressMarker = L.circleMarker([data.lat, data.lon], { color: '#7030A0', radius: 10, fillOpacity: 1 }).addTo(map);
            map.setView([data.lat, data.lon], 16);
        }

        init();
    </script>
</body>
</html>