<!DOCTYPE html>
<html>

<head>
    <title>Utility Incentive Eligibility Checker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* Base Styling - Consistent with professional theme */
        body { font-family: Arial, sans-serif; }
        h2 { color: #015473; /* Dark Blue */ }
        #map { height: 400px; width: 100%; margin-top: 20px; border: 1px solid #B3B3B3; border-radius: 5px; }
        
        /* Result Box Styling */
        .result {
            padding: 20px;
            margin: 15px 0;
            border-radius: 6px;
            border-width: 2px;
            border-style: solid;
        }
        
        /* Color Classes - Enhanced professional look */
        /* Success (Green) */
        .eligible { 
            background: #e6f1e7;
            border-color: #448C49;
        }
        /* Warning/Not Eligible (Orange) */
        .not-eligible { 
            background: #fdf0e6;
            border-color: #ED7D31;
        }
        /* Service Area/Utility Check Failure (Yellow/Grey) */
        .service-area-fail { 
            background: #fffae8;
            border-color: #FFC000;
        }
        
        /* Input & Button Styling */
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #015473; /* Dark Blue Text */
        }
        .input-group input, .input-group select {
            width: 100%;
            max-width: 450px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 16px;
            border: 1px solid #B3B3B3;
            border-radius: 4px;
            box-sizing: border-box; 
        }
        .input-group button { 
            padding: 12px 25px; 
            font-size: 16px; 
            cursor: pointer; 
            background-color: #068DBC; /* Medium Blue Action Color */
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .input-group button:hover {
            background-color: #015473; /* Dark Blue on hover */
        }

        /* Feeder Capacity Display */
        .capacity-pill {
            display: inline-block;
            padding: 2px 8px;
            margin-right: 5px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 13px;
        }
        .cap-low { background-color: #448C49; color: white; } /* Green for good capacity */
        .cap-high { background-color: #ED7D31; color: white; } /* Orange for high capacity */
    </style>

</head>

<body>
    <h2>Utility Incentive Eligibility Checker</h2>
    <p>Please confirm your utility and enter your address to check eligibility for enhanced energy incentives based on local grid capacity.</p>

    <div class="input-group">
        <label for="utility-select">1. Select Your Utility Provider:</label>
        <select id="utility-select">
            <option value="">-- Select Utility --</option>
            <option value="ri-energy">Rhode Island Energy</option>
            <option value="other">Other Utility</option>
        </select>
        
        <label for="address">2. Enter Your Address:</label>
        <input id="address" type="text" placeholder="e.g., 123 Main St, Providence, RI">
        
        <button onclick="checkAddress()">Check Eligibility</button>
    </div>
    
    <div id="result"></div>
    <div id="map"></div>

    <script>
        // --- CONFIGURATION ---
        const CAPACITY_THRESHOLD_PCT = 90; 
        // --- FILE NAMES ---
        const FEEDER_FILE = 'https://raw.githubusercontent.com/0jgreen0/hosting-capacity/5d06d53720299f2f55e0e55ca31d12898caceebc/ngrid_sample_feeders.geojson';
        const INCLUSION_FILE = 'https://raw.githubusercontent.com/0jgreen0/hosting-capacity/5d06d53720299f2f55e0e55ca31d12898caceebc/inclusion_map/inclusion_map.geojson';

        // Data holders
        let feedersData;
        let inclusionData;
        let feederLayer;
        let addressMarker;
        
        // Initialize map centered on Rhode Island
        let map = L.map('map').setView([41.7, -71.5], 9);
        
        // Reliable Basemap (Esri World Topographic Map)
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
        }).addTo(map);

        // --- LOAD DATA ---
        
        // **RE-ADDED: Inclusion boundary loading and rendering**
        const inclusionPromise = fetch(INCLUSION_FILE) 
             .then(r => r.json())
             .then(data => {
                 inclusionData = data;
                 // Display the service/inclusion area boundary
                 L.geoJSON(data, {
                     style: { color: '#068DBC', weight: 2, fillOpacity: 0.1, fillColor: '#48BCEC' }
                 }).addTo(map).bindPopup("RI Energy Service Area"); 
             })
             .catch(error => { console.warn("Failed to load inclusion data.", error); });


        /**
         * Determines the color for a feeder line based on Generation Capacity.
         */
        function getFeederColor(capacity) {
            // Capacity < 70%: Green (Good Capacity)
            if (capacity <= 70) {
                return '#448C49'; // Green
            } 
            // Capacity 70% to 90%: Yellow/Orange (Warning)
            if (capacity <= 90) {
                return '#FFC000'; // Rich Yellow
            } 
            // Capacity > 90%: Red (High Capacity/Limited Incentive Eligibility)
            return '#C00000'; // Dark Red
        }

        const feedersPromise = fetch(FEEDER_FILE)
            .then(r => r.json())
            .then(data => {
                feedersData = data;
                
                // Color different feeders differently based on capacity
                feederLayer = L.geoJSON(data, {
                    style: function(feature) {
                        const genCap = feature.properties.GEN_CAPACITY_PCT || 100; // Default to 100 if missing
                        return { 
                            color: getFeederColor(genCap), 
                            weight: 2 
                        }; 
                    }
                }).addTo(map).bindPopup(function(layer) {
                     return `Feeder ID: ${layer.feature.properties.FEEDER_ID}<br>
                                 Gen Cap: ${layer.feature.properties.GEN_CAPACITY_PCT}%<br>
                                 Load Cap: ${layer.feature.properties.LOAD_CAPACITY_PCT}%`;
                });
            });

        /**
         * Helper function to determine the capacity styling class.
         */
        function getCapacityClass(capacity) {
            return capacity < CAPACITY_THRESHOLD_PCT ? 'cap-low' : 'cap-high';
        }

        /**
         * Helper function to robustly calculate the minimum distance between a point 
         * and a potentially MultiLineString feature collection.
         * @param {object} point - A Turf point feature.
         * @param {object} feature - A GeoJSON feature (LineString or MultiLineString).
         * @returns {number} The minimum distance in kilometers.
         */
        function getMinDistanceToLine(point, feature) {
            let minDistanceKm = Infinity;
            
            // Use turf.flatten to safely handle MultiLineString and LineString
            const flattened = turf.flatten(feature);

            // Iterate over the flattened collection of individual LineString features
            turf.featureEach(flattened, (lineFeature) => {
                // Check if it's a LineString before calling pointToLineDistance
                if (lineFeature.geometry.type === 'LineString') {
                    const distance_km = turf.pointToLineDistance(point, lineFeature, { units: 'kilometers' });
                    if (distance_km < minDistanceKm) {
                        minDistanceKm = distance_km;
                    }
                }
            });

            return minDistanceKm;
        }


        /**
         * Main function to geocode address and check eligibility.
         */
        async function checkAddress() {
            const utility = document.getElementById('utility-select').value;
            const address = document.getElementById('address').value.trim();
            const resultDiv = document.getElementById('result');
            
            // 1. Utility Check
            if (utility !== 'ri-energy') {
                displayUtilityCheckResult(utility);
                return;
            }
            
            // 2. Address Input Check
            if (!address) {
                alert('Please enter your street address.');
                return;
            }

            // Await both GeoJSON files to be loaded
            try {
                // **UPDATED: Await both promises for service area check**
                await Promise.all([feedersPromise, inclusionPromise]); 
            } catch (error) {
                resultDiv.innerHTML = `<div class="result not-eligible"><h3>Fatal Error</h3><p>Could not load spatial data files. Please contact support.</p></div>`;
                console.error("Data loading error:", error);
                return;
            }
            
            resultDiv.innerHTML = `<div class="result service-area-fail"><h3>Checking Address...</h3><p>Please wait while we check the location.</p></div>`;
            
            // 3. Geocode using Nominatim
            const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=us&limit=1`;
            
            try {
                const geocodeResponse = await fetch(geocodeUrl);
                const geocodeData = await geocodeResponse.json();
                
                if (geocodeData.length === 0) {
                    alert('Address not found. Please try a different format.');
                    resultDiv.innerHTML = `<div class="result not-eligible"><h3>Address Not Found</h3><p>Could not locate the address. Check your spelling.</p></div>`;
                    return;
                }
                
                const lat = parseFloat(geocodeData[0].lat);
                const lon = parseFloat(geocodeData[0].lon);
                const point = turf.point([lon, lat]);
                
                // 4. Service Area Check (INCLUSION LOGIC)
                let isInServiceArea = false;
                if (inclusionData && inclusionData.features) {
                    // Check if point is in any feature of the service area
                    isInServiceArea = inclusionData.features.some(feature => turf.booleanPointInPolygon(point, feature));
                }

                if (!isInServiceArea) {
                    displayResult({ excluded: true, lat, lon, address });
                    return;
                }
                
                // 5. Feeder Proximity and Capacity Check
                let minDistanceKm = Infinity; // Track distance in kilometers
                let nearestFeeder = null;
                
                for (let feature of feedersData.features) {
                    // Use robust distance helper to handle MultiLineString
                    const distance_km = getMinDistanceToLine(point, feature);
                    
                    if (distance_km < minDistanceKm) {
                        minDistanceKm = distance_km;
                        // Assign the entire feature object to get the FEEDER_ID later
                        nearestFeeder = feature; 
                    }
                }
                
                // Final Check
                if (!nearestFeeder) {
                    resultDiv.innerHTML = `<div class="result not-eligible"><h3>Error</h3><p>Could not find a nearby electrical feeder line. Data discrepancy.</p></div>`;
                    return;
                }
                
                const distance_feet = minDistanceKm * 3280.84; 

                // Get capacity data
                const genCap = nearestFeeder.properties.GEN_CAPACITY_PCT;
                const loadCap = nearestFeeder.properties.LOAD_CAPACITY_PCT;

                // Capacity Eligibility Logic (Below CAPACITY_THRESHOLD_PCT is good/eligible)
                const isBatteryEligible = (genCap < CAPACITY_THRESHOLD_PCT) && (loadCap < CAPACITY_THRESHOLD_PCT);
                const isHeatPumpEligible = (loadCap < CAPACITY_THRESHOLD_PCT);

                // 6. Display Results
                displayResult({
                    feeder_id: nearestFeeder.properties.FEEDER_ID, 
                    distance_meters: minDistanceKm * 1000, 
                    distance_feet: distance_feet,
                    gen_cap: genCap,
                    load_cap: loadCap,
                    isBatteryEligible,
                    isHeatPumpEligible,
                    lat: lat,
                    lon: lon,
                    address: address
                });
                
            } catch (error) {
                console.error("Processing error:", error); 
                resultDiv.innerHTML = `<div class="result not-eligible"><h3>Error</h3><p>An unexpected error occurred during processing. Please verify address or contact support.</p></div>`;
            }
        }
        
        function displayUtilityCheckResult(utility) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = 'result service-area-fail';
            
            if (utility === 'other') {
                resultDiv.innerHTML = `
                    <h3>Utility Not Supported</h3>
                    <p><strong>Reason:</strong> This incentive program is exclusively for **Rhode Island Energy** customers.</p>
                    <p>Please contact your utility provider for their incentive programs.</p>
                `;
            } else { // No utility selected
                     resultDiv.innerHTML = `
                        <h3>Please Select Utility</h3>
                        <p>Please use the drop-down menu to confirm you are a Rhode Island Energy customer to proceed with the check.</p>
                    `;
            }
        }

        function displayResult(data) {
            const resultDiv = document.getElementById('result');
            
            if (data.excluded) {
                resultDiv.className = 'result not-eligible';
                resultDiv.innerHTML = `
                    <h3>Eligibility Check Failed (Service Area)</h3>
                    <p><strong>Reason:</strong> This address appears to be outside the **Rhode Island Energy service area**. Enhanced incentives are not available.</p>
                    <p><strong>Address:</strong> ${data.address}</p>
                `;
            } else {
                // Determine overall visual class based on if *any* incentive is available
                const overallEligible = data.isBatteryEligible || data.isHeatPumpEligible;
                const eligibleClass = overallEligible ? 'eligible' : 'not-eligible';
                
                // Helper to format capacity display
                const genCapClass = getCapacityClass(data.gen_cap);
                const loadCapClass = getCapacityClass(data.load_cap);

                resultDiv.className = `result ${eligibleClass}`;
                resultDiv.innerHTML = `
                    <h3>${overallEligible ? 'Eligible for Enhanced Incentives' : 'Enhanced Incentives Not Available'}</h3>
                    
                    <p style="margin-top: 15px;">Feeder capacity must be **below ${CAPACITY_THRESHOLD_PCT}%** to qualify for enhanced incentives.</p>
                    <hr style="border-color: #B3B3B3;">
                    
                    <h4>Battery Storage Incentive</h4>
                    <p>
                        **Status:** ${data.isBatteryEligible ? '<strong>ELIGIBLE</strong>' : 'NOT Eligible'}
                        <br>
                        **Requirement:** Both Generation and Load capacity must be low.
                        <br>
                        **Capacity Found:** <span class="capacity-pill ${genCapClass}">Gen: ${data.gen_cap.toFixed(1)}%</span> 
                        <span class="capacity-pill ${loadCapClass}">Load: ${data.load_cap.toFixed(1)}%</span> 
                    </p>

                    <h4>Heat Pump Incentive</h4>
                    <p>
                        **Status:** ${data.isHeatPumpEligible ? '<strong>ELIGIBLE</strong>' : 'NOT Eligible'}
                        <br>
                        **Requirement:** Load capacity must be low.
                        <br>
                        **Capacity Found:** <span class="capacity-pill ${loadCapClass}">Load: ${data.load_cap.toFixed(1)}%</span>
                    </p>
                    
                    <hr style="border-color: #B3B3B3;">
                    <p style="font-size: 14px;"><strong>Nearest Feeder ID:</strong> ${data.feeder_id}</p>
                    <p style="font-size: 14px;"><strong>Distance to Feeder:</strong> ${Math.round(data.distance_feet)} feet (${(data.distance_meters / 1000).toFixed(3)} km)</p>

                    <p style="font-size: 12px; color: #808080; margin-top: 15px;">
                        <em>Disclaimer: This tool provides a preliminary estimate based on current feeder data. Eligibility is subject to final review by Rhode Island Energy.</em>
                    </p>
                `;
            }
            
            // Update map
            if (addressMarker) {
                map.removeLayer(addressMarker);
            }
            // Use Purple for the address marker for contrast/focus
            addressMarker = L.marker([data.lat, data.lon], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: #7030A0; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [26, 26],
                    iconAnchor: [13, 13]
                })
            })
                .addTo(map)
                .bindPopup(data.address)
                .openPopup();
            map.setView([data.lat, data.lon], 14);
        }
    </script>

</body>
</html>