<!DOCTYPE html>
<html>

<head>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Styles for the page elements */
        #map { height: 400px; width: 100%; margin-top: 15px; }
        .result {
            padding: 20px;
            margin: 10px 0;
            border-radius: 5px;
            border: 2px solid #ccc;
        }
        /* Color classes based on incentive eligibility status */
        .eligible { background: #d4edda; border-color: #28a745; }
        .not-eligible { background: #f8d7da; border-color: #dc3545; }
        .service-area-fail { background: #fff3cd; border-color: #ffc107; }
        
        /* Input styling */
        .input-group label, .input-group select, .input-group input, .input-group button {
            display: block;
            margin-bottom: 10px;
        }
        .input-group input, .input-group select {
            width: 100%;
            max-width: 400px;
            padding: 8px;
            font-size: 14px;
            box-sizing: border-box; /* Include padding in width calculation */
        }
        .input-group button { 
            padding: 10px 20px; 
            font-size: 16px; 
            cursor: pointer; 
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
    </style>

</head>

<body>
    <h2>‚ö° Enhanced Incentive Eligibility Checker</h2>
    <p>Please confirm your utility and enter your address to check eligibility for enhanced energy incentives.</p>

    <div class="input-group">
        <label for="utility-select">1. Select Your Utility Provider:</label>
        <select id="utility-select">
            <option value="">-- Select Utility --</option>
            <option value="ri-energy">Rhode Island Energy (Electric & Gas)</option>
            <option value="other">Other Utility (e.g., Block Island Power)</option>
        </select>
        
        <label for="address">2. Enter Your Address:</label>
        <input id="address" type="text" placeholder="123 Main St, Providence, RI">
        
        <button onclick="checkAddress()">Check Eligibility</button>
    </div>
    
    <div id="result"></div>
    <div id="map"></div>

    <script>
        // --- CONFIGURATION ---
        // Capacity Threshold: Below this percentage means the feeder has capacity (is eligible).
        const CAPACITY_THRESHOLD_PCT = 90; 

        // Data holders
        let feedersData;
        let inclusionData; // Your former exclusion data is now interpreted as the INCLUSION boundary (Service Area)
        let feederLayer;
        let addressMarker;
        
        // Initialize map centered on Rhode Island
        let map = L.map('map').setView([41.7, -71.5], 9);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Load data files (Ensure these GeoJSON files are hosted and accessible)
        // Note: The previous logic assumed 'exclusion_zones.geojson' defined excluded areas.
        // Based on the Python script, we'll assume a file defining the INCLUSION (service) area. 
        // We will rename the file to 'service_area.geojson' for clarity in this web context.
        const serviceAreaPromise = fetch('service_area.geojson') 
            .then(r => r.json())
            .then(data => {
                inclusionData = data;
                // Display the service/inclusion area boundary
                L.geoJSON(data, {
                    style: { color: '#00cc00', weight: 2, fillOpacity: 0.1, fillColor: '#00cc00' }
                }).addTo(map).bindPopup("RI Energy Service Area");
            });

        const feedersPromise = fetch('load_hosting_feeders.geojson')
            .then(r => r.json())
            .then(data => {
                feedersData = data;
                feederLayer = L.geoJSON(data, {
                    style: { color: '#0066cc', weight: 2 }
                }).addTo(map).bindPopup(function(layer) {
                     return `Feeder ID: ${layer.feature.properties.FEEDER_ID}<br>
                             Gen Cap: ${layer.feature.properties.GEN_CAPACITY_PCT}%<br>
                             Load Cap: ${layer.feature.properties.LOAD_CAPACITY_PCT}%`;
                });
            });

        /**
         * Main function to geocode address and check eligibility.
         */
        async function checkAddress() {
            const utility = document.getElementById('utility-select').value;
            const address = document.getElementById('address').value.trim();
            const resultDiv = document.getElementById('result');
            
            // 1. Utility Check
            if (utility !== 'ri-energy') {
                displayUtilityCheckResult(utility);
                return;
            }
            
            // 2. Address Input Check
            if (!address) {
                alert('Please enter your street address.');
                return;
            }

            // Await both GeoJSON files to be loaded
            await Promise.all([serviceAreaPromise, feedersPromise]).catch(error => {
                resultDiv.innerHTML = `<div class="result not-eligible"><h3>Fatal Error</h3><p>Could not load spatial data files. Please contact support.</p></div>`;
                console.error("Data loading error:", error);
                return;
            });
            
            resultDiv.innerHTML = `<div class="result service-area-fail"><h3>‚è≥ Checking Address...</h3><p>Please wait while we check the location.</p></div>`;
            
            // 3. Geocode using Nominatim
            const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=us&limit=1`;
            
            try {
                const geocodeResponse = await fetch(geocodeUrl);
                const geocodeData = await geocodeResponse.json();
                
                if (geocodeData.length === 0) {
                    alert('Address not found. Please try a different format (e.g., "123 Main St, Providence, RI").');
                    resultDiv.innerHTML = `<div class="result not-eligible"><h3>Address Not Found</h3><p>Could not locate the address. Check your spelling.</p></div>`;
                    return;
                }
                
                const lat = parseFloat(geocodeData[0].lat);
                const lon = parseFloat(geocodeData[0].lon);
                const point = turf.point([lon, lat]);
                
                // 4. Service Area Check (INCLUSION LOGIC)
                let isInServiceArea = false;
                if (inclusionData && inclusionData.features) {
                    for (let feature of inclusionData.features) {
                        // Check if point is in any feature of the service area
                        if (turf.booleanPointInPolygon(point, feature)) {
                            isInServiceArea = true;
                            break;
                        }
                    }
                }

                if (!isInServiceArea) {
                    displayResult({ excluded: true, lat, lon, address });
                    return;
                }
                
                // 5. Feeder Proximity and Capacity Check
                let minDistance = Infinity;
                let nearestFeeder = null;
                
                for (let feature of feedersData.features) {
                    // Turf distance calculation (returns meters)
                    const distance = turf.pointToLineDistance(point, feature, {units: 'meters'});
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestFeeder = feature;
                    }
                }
                
                // Get capacity data (assuming properties GEN_CAPACITY_PCT and LOAD_CAPACITY_PCT exist)
                const genCap = nearestFeeder.properties.GEN_CAPACITY_PCT;
                const loadCap = nearestFeeder.properties.LOAD_CAPACITY_PCT;

                // Capacity Eligibility Logic (Below 90% is good/eligible)
                const isBatteryEligible = (genCap < CAPACITY_THRESHOLD_PCT) && (loadCap < CAPACITY_THRESHOLD_PCT);
                const isHeatPumpEligible = (loadCap < CAPACITY_THRESHOLD_PCT);

                // 6. Display Results
                displayResult({
                    feeder_id: nearestFeeder.properties.FEEDER_ID,
                    distance_meters: minDistance,
                    distance_feet: minDistance * 3.28084,
                    gen_cap: genCap,
                    load_cap: loadCap,
                    isBatteryEligible,
                    isHeatPumpEligible,
                    lat: lat,
                    lon: lon,
                    address: address
                });
                
            } catch (error) {
                alert('Error processing request. Please check the console for details.');
                console.error("Processing error:", error);
                resultDiv.innerHTML = `<div class="result not-eligible"><h3>Error</h3><p>An unexpected error occurred during processing.</p></div>`;
            }
        }
        
        function displayUtilityCheckResult(utility) {
            const resultDiv = document.getElementById('result');
            if (utility === 'other') {
                resultDiv.className = 'result service-area-fail';
                resultDiv.innerHTML = `
                    <h3>‚ö†Ô∏è Utility Not Supported</h3>
                    <p><strong>Reason:</strong> This incentive program is exclusively for **Rhode Island Energy** customers.</p>
                    <p>Please contact your utility provider for their incentive programs.</p>
                `;
            } else { // No utility selected
                 resultDiv.className = 'result service-area-fail';
                 resultDiv.innerHTML = `
                    <h3>‚ö†Ô∏è Please Select Utility</h3>
                    <p>Please use the drop-down menu to confirm you are a Rhode Island Energy customer.</p>
                `;
            }
        }

        function displayResult(data) {
            const resultDiv = document.getElementById('result');
            
            if (data.excluded) {
                resultDiv.className = 'result not-eligible';
                resultDiv.innerHTML = `
                    <h3>‚úó Not Eligible (Service Area)</h3>
                    <p><strong>Reason:</strong> This address appears to be outside the **Rhode Island Energy service area**. Incentives are not available.</p>
                    <p><strong>Address:</strong> ${data.address}</p>
                `;
            } else {
                // Determine overall visual class based on if *any* incentive is available
                const overallEligible = data.isBatteryEligible || data.isHeatPumpEligible;
                const eligibleClass = overallEligible ? 'eligible' : 'not-eligible';
                
                resultDiv.className = `result ${eligibleClass}`;
                resultDiv.innerHTML = `
                    <h3>${overallEligible ? 'üéâ Eligible for Enhanced Incentives' : '‚úó Enhanced Incentives Not Available'}</h3>
                    
                    <p><strong>Capacity Threshold:</strong> Feeder capacity must be **below ${CAPACITY_THRESHOLD_PCT}%** to qualify for enhanced incentives.</p>
                    <hr>
                    
                    <h4>üîã Battery Storage Incentive</h4>
                    <p>
                        **Status:** ${data.isBatteryEligible ? '‚úÖ **ELIGIBLE**' : '‚ùå NOT Eligible'}
                        <br>
                        **Requirement:** Both **Generation Capacity** (${data.gen_cap.toFixed(1)}%) AND **Load Capacity** (${data.load_cap.toFixed(1)}%) must be below ${CAPACITY_THRESHOLD_PCT}%.
                    </p>

                    <h4>üî• Heat Pump Incentive</h4>
                    <p>
                        **Status:** ${data.isHeatPumpEligible ? '‚úÖ **ELIGIBLE**' : '‚ùå NOT Eligible'}
                        <br>
                        **Requirement:** **Load Capacity** (${data.load_cap.toFixed(1)}%) must be below ${CAPACITY_THRESHOLD_PCT}%.
                    </p>
                    
                    <hr>
                    <p style="font-size: 14px;"><strong>Nearest Feeder ID:</strong> ${data.feeder_id}</p>
                    <p style="font-size: 14px;"><strong>Distance to Feeder:</strong> ${Math.round(data.distance_feet)} feet (${Math.round(data.distance_meters)} meters)</p>

                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        <em>Disclaimer: This tool provides a preliminary estimate based on current feeder data. Eligibility is subject to final review by Rhode Island Energy.</em>
                    </p>
                `;
            }
            
            // Update map
            if (addressMarker) {
                map.removeLayer(addressMarker);
            }
            addressMarker = L.marker([data.lat, data.lon])
                .addTo(map)
                .bindPopup(data.address)
                .openPopup();
            map.setView([data.lat, data.lon], 14);
        }
    </script>

</body>
</html>