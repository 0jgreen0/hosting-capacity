<!DOCTYPE html>
<html>
<head>
    <title>Utility Incentive Eligibility Checker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; color: #333; line-height: 1.5; }
        h2 { color: #015473; margin-top: 0; }
        
        .main-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .form-section { flex: 1; min-width: 300px; }
        .guide-section { width: 300px; background: #f9f9f9; padding: 20px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; }
        
        #map { height: 500px; width: 100%; margin-top: 20px; border: 1px solid #B3B3B3; border-radius: 5px; }
        
        .result { padding: 20px; margin: 15px 0; border-radius: 6px; border-width: 2px; border-style: solid; }
        .eligible { background: #eef6fb; border-color: #005a8d; }
        .not-eligible { background: #fff5eb; border-color: #d95f02; }
        .service-area-fail { background: #f2f2f2; border-color: #757575; }
        
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #015473; margin-top: 15px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #B3B3B3; border-radius: 4px; box-sizing: border-box; }
        .input-group button { width: 100%; margin-top: 20px; padding: 12px; font-size: 16px; font-weight: bold; cursor: pointer; background-color: #068DBC; color: white; border: none; border-radius: 4px; transition: background 0.2s; }
        .input-group button:hover { background-color: #005a8d; }
        
        .capacity-pill { display: inline-block; padding: 2px 8px; margin-right: 5px; border-radius: 12px; font-weight: bold; font-size: 13px; color: white; }
        .cap-eligible { background-color: #005a8d; } 
        .cap-ineligible { background-color: #d95f02; }

        .guide-section h4 { margin-top: 0; color: #015473; border-bottom: 2px solid #068DBC; padding-bottom: 5px; }
        .guide-item { margin-bottom: 12px; }
        .guide-item strong { display: block; color: #444; }

        .disclaimer-box { margin-top: 30px; font-size: 13px; color: #666; border-top: 1px solid #ccc; padding-top: 15px; }
    </style>
</head>

<body>
    <h2>Utility Incentive Eligibility Checker</h2>

    <div class="main-container">
        <div class="form-section">
            <div class="input-group">
                <label for="utility-select">1. Utility Provider</label>
                <select id="utility-select">
                    <option value="ri-energy">Rhode Island Energy</option>
                    <option value="other">Other Utility</option>
                </select>
                
                <label for="service-level">2. Service Level & Type</label>
                <select id="service-level">
                    <option value="4">Single/Two Phase Overhead</option>
                    <option value="5">Single/Two Phase Underground</option>
                    <option value="1">Three Phase Overhead</option>
                    <option value="2">Three Phase Underground</option>
                </select>

                <label for="address">3. Property Address</label>
                <input id="address" type="text" placeholder="e.g., 123 Main St, Providence, RI">
                
                <button onclick="checkAddress()">Check Eligibility</button>
            </div>
            <div id="result"></div>
        </div>

        <div class="guide-section">
            <h4>Service Type Guide</h4>
            <div class="guide-item">
                <strong>Single/Two Phase</strong>
                Standard for most residential homes, small apartments, and small offices.
            </div>
            <div class="guide-item">
                <strong>Three Phase</strong>
                Common for large commercial buildings, manufacturing, and heavy industrial use.
            </div>
            <div class="guide-item">
                <strong>Overhead vs. Underground</strong>
                Look at your meter. If wires come from a pole, choose <b>Overhead</b>. If wires come from a green box or the ground, choose <b>Underground</b>.
            </div>
        </div>
    </div>
    
    <div id="map"></div>

    <div class="disclaimer-box">
        <p>This tool reflects data from the RI Office of Energy Resources. Verified data can be found at the <a href="https://portalconnect.rienergy.com/RI/s/article/Rhode-Island-System-Data-Portal" target="_blank">RI Energy System Data Portal</a>.</p>
    </div>

    <script>
        const CAPACITY_THRESHOLD_PCT = 90; 
        const FEEDER_FILE = 'https://raw.githubusercontent.com/0jgreen0/hosting-capacity/main/ngrid_sample_feeders.geojson';
        const INCLUSION_FILE = 'https://raw.githubusercontent.com/0jgreen0/hosting-capacity/main/inclusion_map/inclusion_map.geojson';

        const COLOR_ELIGIBLE = '#005a8d';
        const COLOR_INELIGIBLE = '#d95f02';

        let feedersData, inclusionData, addressMarker;
        let storageLayer = L.layerGroup();
        let heatPumpLayer = L.layerGroup();
        let map = L.map('map').setView([41.7, -71.5], 9);
        
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        }).addTo(map);

        // Load Data
        fetch(INCLUSION_FILE).then(r => r.json()).then(data => {
            inclusionData = data;
            L.geoJSON(data, { style: { color: '#015473', weight: 1, fillOpacity: 0.05, interactive: false } }).addTo(map);
        });

        fetch(FEEDER_FILE).then(r => r.json()).then(data => {
            feedersData = data;
            createMapLayers(data);
        });

        function createMapLayers(data) {
            L.geoJSON(data, {
                style: (f) => ({
                    color: (f.properties.GEN_CAPACITY_PCT < CAPACITY_THRESHOLD_PCT && f.properties.LOAD_CAPACITY_PCT < CAPACITY_THRESHOLD_PCT) ? COLOR_ELIGIBLE : COLOR_INELIGIBLE,
                    weight: 3
                })
            }).addTo(storageLayer);

            L.geoJSON(data, {
                style: (f) => ({
                    color: (f.properties.LOAD_CAPACITY_PCT < CAPACITY_THRESHOLD_PCT) ? COLOR_ELIGIBLE : COLOR_INELIGIBLE,
                    weight: 3
                })
            }).addTo(heatPumpLayer);

            heatPumpLayer.addTo(map);
            L.control.layers({"Heat Pump View": heatPumpLayer, "Storage View": storageLayer}, null, {collapsed: false}).addTo(map);
        }

        function getMinDistanceToLine(point, feature) {
            let minDistanceKm = Infinity;
            const flattened = turf.flatten(feature);
            turf.featureEach(flattened, (lineFeature) => {
                const d = turf.pointToLineDistance(point, lineFeature, { units: 'kilometers' });
                if (d < minDistanceKm) minDistanceKm = d;
            });
            return minDistanceKm;
        }

        async function checkAddress() {
            const utility = document.getElementById('utility-select').value;
            const address = document.getElementById('address').value.trim();
            const resultDiv = document.getElementById('result');
            
            if (utility !== 'ri-energy') { displayUtilityError(utility); return; }
            if (!address) { alert('Please enter an address.'); return; }

            resultDiv.innerHTML = "Locating address and analyzing feeders...";

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=us&limit=1`);
                const geoData = await response.json();
                if (geoData.length === 0) throw new Error("Address not found.");

                const lat = parseFloat(geoData[0].lat);
                const lon = parseFloat(geoData[0].lon);
                const point = turf.point([lon, lat]);

                const inArea = inclusionData.features.some(f => turf.booleanPointInPolygon(point, f));
                if (!inArea) { displayResult({excluded: true}); return; }

                let minDist = Infinity;
                let nearest = null;
                
                feedersData.features.forEach(f => {
                    const d = getMinDistanceToLine(point, f);
                    if (d < minDist) { minDist = d; nearest = f; }
                });

                displayResult({
                    feeder_id: nearest.properties.OBJECTID, // Map OBJECTID to Feeder ID
                    gen: nearest.properties.GEN_CAPACITY_PCT,
                    load: nearest.properties.LOAD_CAPACITY_PCT,
                    dist_ft: minDist * 3280.84,
                    lat, lon
                });
            } catch (e) {
                resultDiv.innerHTML = `<div class="result not-eligible"><h3>Error</h3><p>${e.message}</p></div>`;
            }
        }

        function displayResult(data) {
            const res = document.getElementById('result');
            if (data.excluded) {
                res.className = "result not-eligible";
                res.innerHTML = "<h3>Service Area Error</h3><p>Address is outside Rhode Island Energy's service area.</p>";
                return;
            }

            const isHE = data.load < CAPACITY_THRESHOLD_PCT;
            const isSE = (data.gen < CAPACITY_THRESHOLD_PCT && data.load < CAPACITY_THRESHOLD_PCT);

            res.className = `result ${(isHE || isSE) ? 'eligible' : 'not-eligible'}`;
            res.innerHTML = `
                <h3>${(isHE || isSE) ? 'Eligible for Enhanced Incentives' : 'Not Eligible'}</h3>
                <p>Calculated for Feeder ID: <strong>${data.feeder_id}</strong></p>
                <hr>
                <p><strong>Battery Storage:</strong> ${isSE ? 'ELIGIBLE' : 'NOT ELIGIBLE'}<br>
                <span class="capacity-pill ${data.gen < 90 ? 'cap-eligible' : 'cap-ineligible'}">Gen: ${data.gen}%</span>
                <span class="capacity-pill ${data.load < 90 ? 'cap-eligible' : 'cap-ineligible'}">Load: ${data.load}%</span></p>

                <p><strong>Heat Pump:</strong> ${isHE ? 'ELIGIBLE' : 'NOT ELIGIBLE'}<br>
                <span class="capacity-pill ${data.load < 90 ? 'cap-eligible' : 'cap-ineligible'}">Load: ${data.load}%</span></p>
                <p style="font-size:11px; color:#666;">Distance to asset: ${Math.round(data.dist_ft)} ft</p>
            `;

            if (addressMarker) map.removeLayer(addressMarker);
            addressMarker = L.circleMarker([data.lat, data.lon], {color: '#7030A0', radius: 8, fillOpacity: 1}).addTo(map);
            map.setView([data.lat, data.lon], 15);
        }

        function displayUtilityError(u) {
            const res = document.getElementById('result');
            res.className = "result service-area-fail";
            res.innerHTML = "<h3>Utility Not Supported</h3><p>This program is currently restricted to Rhode Island Energy customers.</p>";
        }
    </script>
</body>
</html>